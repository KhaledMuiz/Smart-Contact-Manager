<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contacts | Smart Contact Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="css/contacts.css">
</head>

<body>
    <!-- CONTACTS -->
    <header class="header">
        <div class="logo">
            <i class="fa-solid fa-address-book"></i>
            <span>Smart Contact Manager</span>
        </div>
        <nav class="navbar">
            <div class="hamburger">
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">Home</a></li>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="contacts.html">Contacts</a></li>
                <li><a href="#logout">Logout</a></li>
            </ul>
        </nav>
    </header>

    <main class="contacts-page">
        <section class="contacts-header">
            <h1>My Contacts</h1>
            <div class="actions-bar">
                <input type="text" placeholder="Search contacts..." id="searchInput">
                <select id="filterSelect">
                    <option value="all">All</option>
                    <option value="work">Work</option>
                    <option value="personal">Personal</option>
                    <option value="favorites">Favorites</option>
                </select>
                <button class="btn" onclick="addContactPage()">
                    <i class="fas fa-user-plus"></i> Add Contact
                </button>
            </div>
        </section>

        <!-- Contacts Grid -->
        <section class="contacts-grid" id="contactsGrid">
            <!-- Contacts will be loaded dynamically -->
        </section>

        <!-- Slide-in Edit Panel -->
        <div id="editPanel" class="edit-panel">
            <h2>Edit Contact</h2>
            <form id="editForm" enctype="multipart/form-data">
                <div class="input-group">
                    <label for="editName">Full Name</label>
                    <input type="text" id="editName" name="name" required>
                </div>
                <div class="input-group">
                    <label for="editEmail">Email</label>
                    <input type="email" id="editEmail" name="email" required>
                </div>
                <div class="input-group">
                    <label for="editPhone">Phone</label>
                    <input type="tel" id="editPhone" name="phone" required>
                </div>
                <div class="input-group">
                    <label for="editAddress">Address</label>
                    <input type="text" id="editAddress" name="address">
                </div>
                <div class="input-group">
                    <label>Category</label>
                    <label><input type="radio" name="category" value="work" id="editCategoryWork"> Work</label>
                    <label><input type="radio" name="category" value="personal" id="editCategoryPersonal"> Personal</label>
                </div>
                <div class="input-group" style="position: relative;">
                    <label for="editNotes">Notes</label>
                    <textarea id="editNotes" name="notes" rows="3"></textarea>
                    <div class="character-counter">0 / 500</div>
                </div>
                <div class="input-group">
                    <label><input type="checkbox" id="editFavorite" name="is_favorite"> Favorite</label>
                </div>
                <div class="input-group">
                    <label for="editProfileImage">Profile Image</label>
                    <div id="imageDropArea" style="border: 2px dashed var(--gray); padding: 1rem; text-align: center; cursor: pointer;">
                        Drag & Drop image here or click to select
                        <input type="file" id="editProfileImage" name="profile_image" accept="image/*" style="display:none;">
                        <div id="imagePreview" style="margin-top: 1rem;">
                            <!-- Image preview will appear here -->
                        </div>
                    </div>
                </div>
                <div class="panel-actions">
                    <button type="button" class="btn danger" onclick="closeEditPanel()">Cancel</button>
                    <button type="submit" class="btn">Save</button>
                </div>
            </form>
        </div>

    </main>

    <script>
/* Contacts page script â€” paste into contacts.html */
const API_BASE = 'http://localhost:3000/api';
const token = localStorage.getItem('token');
if (!token) window.location.href = 'login.html';

loadContacts();

async function loadContacts() {
    try {
        const res = await fetch(`${API_BASE}/contacts`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) {
            console.error('Failed to load contacts, status:', res.status);
            return;
        }
        const contacts = await res.json();
        renderContacts(contacts || []);
    } catch (err) {
        console.error('Error loading contacts:', err);
    }
}

function renderContacts(contacts) {
    const grid = document.getElementById('contactsGrid');
    grid.innerHTML = '';

    contacts.forEach((contact, index) => {
        const cid = contact.id || contact._id || '';
        if (!cid) console.warn('Contact missing id/_id:', contact);

        const card = document.createElement('div');
        card.className = 'contact-card';
        card.style.animationDelay = `${index * 0.1}s`;
        card.setAttribute('data-id', cid);
        card.setAttribute('data-type', contact.category || 'personal');
        card.setAttribute('data-fav', contact.is_favorite ? 'true' : 'false');

        if (contact.is_favorite) {
            const favBadge = document.createElement('span');
            favBadge.className = 'fav-badge';
            favBadge.innerHTML = '<i class="fas fa-star"></i>';
            card.appendChild(favBadge);
        }

        const img = document.createElement('img');
        if (contact.profile_image) {
            if (contact.profile_image.startsWith('profile_image-')) {
                img.src = `/uploads/${contact.profile_image}`;
            } else {
                img.src = `./src/images/${contact.profile_image}`;
            }
        } else {
            img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjUwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0zMCA0NUMzMCAzOC41IDI2LjUgMzMgMzAgMzNDMzMgMjYuNSAzOC41IDIxIDQ1IDIxQzUxLjUgMjEgNTcgMjYuNSA1NyAzM0M1NyAzOC41IDUxLjUgNDUgNDUgNDVDNTEuNSA1MS41IDU3IDU3IDU3IDYzVjY5QzU3IDc1LjUgNTEuNSA4MSA0NSA4MUMzOC41IDgxIDMzIDc1LjUgMzMgNjlWMzNaIiBmaWxsPSIjOUI5QkE0Ii8+Cjwvc3ZnPgo=';
        }
        img.alt = `Headshot of ${contact.name || 'no-name'}`;
        card.appendChild(img);

        const h3 = document.createElement('h3');
        const a = document.createElement('a');
        a.href = `contact-detail.html?id=${encodeURIComponent(cid)}`;
        a.textContent = contact.name || 'Unnamed';
        h3.appendChild(a);
        card.appendChild(h3);

        if (contact.email) {
            const pEmail = document.createElement('p');
            pEmail.innerHTML = `<i class="fas fa-envelope"></i> ${contact.email}`;
            card.appendChild(pEmail);
        }

        if (contact.phone) {
            const pPhone = document.createElement('p');
            pPhone.innerHTML = `<i class="fas fa-phone"></i> ${contact.phone}`;
            card.appendChild(pPhone);
        }

        if (contact.address) {
            const pAddress = document.createElement('p');
            pAddress.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${contact.address}`;
            card.appendChild(pAddress);
        }

        if (contact.category) {
            const pCategory = document.createElement('p');
            pCategory.innerHTML = `<i class="fas fa-tag"></i> ${contact.category}`;
            card.appendChild(pCategory);
        }

        const actions = document.createElement('div');
        actions.className = 'contact-actions';

        const editBtn = document.createElement('button');
        editBtn.className = 'btn small edit-btn';
        editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit';
        editBtn.onclick = () => openEditPanel(card, contact);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn small danger delete-btn';
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Delete';
        deleteBtn.onclick = () => deleteContact(cid, card);

        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);
        card.appendChild(actions);

        grid.appendChild(card);
    });
}

/* Delete contact */
async function deleteContact(contactId, card) {
    if (!confirm('Are you sure you want to delete this contact?')) return;
    try {
        const res = await fetch(`${API_BASE}/contacts/${encodeURIComponent(contactId)}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (res.ok) card.remove();
        else alert('Failed to delete contact (status ' + res.status + ')');
    } catch (err) {
        console.error('Error deleting contact:', err);
        alert('Error deleting contact');
    }
}

/* Edit panel logic */
const editPanel = document.getElementById("editPanel");
const editForm = document.getElementById("editForm");
let currentContact = null;
let currentCard = null;

function openEditPanel(card, contact) {
    currentCard = card;
    currentContact = contact;
    document.getElementById("editName").value = contact.name || '';
    document.getElementById("editEmail").value = contact.email || '';
    document.getElementById("editPhone").value = contact.phone || '';
    document.getElementById("editAddress").value = contact.address || '';
    document.getElementById("editNotes").value = contact.notes || '';
    // Character counter for notes
    const notesTextarea = document.getElementById('editNotes');
    const characterCounter = document.querySelector('.character-counter');
    notesTextarea.addEventListener('input', function() {
      const length = this.value.length;
      characterCounter.textContent = `${length} / 500`;
      if (length > 500) {
        characterCounter.style.color = 'red';
      } else {
        characterCounter.style.color = '#94a3b8';
      }
    });
    // Initial update
    const initialLength = notesTextarea.value.length;
    characterCounter.textContent = `${initialLength} / 500`;
    document.getElementById("editFavorite").checked = contact.is_favorite || false;
    if (contact.category) {
        if (contact.category === 'work') {
            document.getElementById("editCategoryWork").checked = true;
        } else {
            document.getElementById("editCategoryPersonal").checked = true;
        }
    } else {
        document.getElementById("editCategoryPersonal").checked = true;
    }
    // Clear image preview
    document.getElementById("imagePreview").innerHTML = '';
    document.getElementById("editProfileImage").value = '';
    editPanel.classList.add("active");
}

function closeEditPanel() {
    editPanel.classList.remove("active");
    currentContact = null;
    currentCard = null;
    // Clear image preview
    document.getElementById("imagePreview").innerHTML = '';
    document.getElementById("editProfileImage").value = '';
}

editForm.addEventListener("submit", async function (e) {
    e.preventDefault();
    if (!currentContact) return;
    const idForApi = currentContact.id || currentContact._id;
    const formData = new FormData();
    formData.append('name', document.getElementById("editName").value);
    formData.append('email', document.getElementById("editEmail").value);
    formData.append('phone', document.getElementById("editPhone").value);
    formData.append('address', document.getElementById("editAddress").value);
    formData.append('category', document.querySelector('input[name="category"]:checked').value);
    formData.append('notes', document.getElementById("editNotes").value);
    formData.append('is_favorite', document.getElementById("editFavorite").checked);
    const imageFile = document.getElementById("editProfileImage").files[0];
    if (imageFile) {
        formData.append('profile_image', imageFile);
    }
    try {
        const res = await fetch(`${API_BASE}/contacts/${encodeURIComponent(idForApi)}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });
        if (!res.ok) {
            alert('Failed to update contact (status ' + res.status + ')');
            return;
        }
        const updatedContact = await res.json();
        // Update the card DOM safely: find paragraphs by icon and update all fields
        if (currentCard) {
            currentCard.querySelector('h3 a').textContent = updatedContact.name || '';
            const pTags = Array.from(currentCard.querySelectorAll('p'));
            const pEmail = pTags.find(p => p.innerHTML.includes('fa-envelope'));
            const pPhone = pTags.find(p => p.innerHTML.includes('fa-phone'));
            const pAddress = pTags.find(p => p.innerHTML.includes('fa-map-marker-alt'));
            const pCategory = pTags.find(p => p.innerHTML.includes('fa-tag'));
            if (pEmail) pEmail.innerHTML = '<i class="fas fa-envelope"></i> ' + (updatedContact.email || '');
            if (pPhone) pPhone.innerHTML = '<i class="fas fa-phone"></i> ' + (updatedContact.phone || '');
            if (pAddress) pAddress.innerHTML = '<i class="fas fa-map-marker-alt"></i> ' + (updatedContact.address || '');
            if (pCategory) pCategory.innerHTML = '<i class="fas fa-tag"></i> ' + (updatedContact.category || '');
            // Update favorite badge
            const favBadge = currentCard.querySelector('.fav-badge');
            if (updatedContact.is_favorite) {
                if (!favBadge) {
                    const newFavBadge = document.createElement('span');
                    newFavBadge.className = 'fav-badge';
                    newFavBadge.innerHTML = '<i class="fas fa-star"></i>';
                    currentCard.appendChild(newFavBadge);
                }
            } else {
                if (favBadge) favBadge.remove();
            }
            // Update image if new image was uploaded
            if (updatedContact.profile_image) {
                const img = currentCard.querySelector('img');
                if (img) {
                    if (updatedContact.profile_image.startsWith('profile_image-')) {
                        img.src = `/uploads/${updatedContact.profile_image}`;
                    } else {
                        img.src = `./src/images/${updatedContact.profile_image}`;
                    }
                }
            }
            // Update data attributes
            currentCard.setAttribute('data-type', updatedContact.category || 'personal');
            currentCard.setAttribute('data-fav', updatedContact.is_favorite ? 'true' : 'false');
        }
        // keep local reference in sync for further edits
        currentContact = Object.assign(currentContact, updatedContact);
        closeEditPanel();
    } catch (err) {
        console.error('Error updating contact:', err);
        alert('Error updating contact');
    }
});

/* Filters and search (unchanged) */
document.getElementById("filterSelect").addEventListener("change", function () {
    const value = this.value;
    document.querySelectorAll(".contact-card").forEach(card => {
        const type = card.getAttribute("data-type");
        const fav = card.getAttribute("data-fav");
        if (value === "all") card.style.display = "block";
        else if (value === "favorites" && fav === "true") card.style.display = "block";
        else if (value === type) card.style.display = "block";
        else card.style.display = "none";
    });
});

document.getElementById("searchInput").addEventListener("input", function () {
    const query = this.value.toLowerCase();
    document.querySelectorAll(".contact-card").forEach(card => {
        const text = card.innerText.toLowerCase();
        card.style.display = text.includes(query) ? "block" : "none";
    });
});

/* Navbar / hamburger / logout logic (unchanged) */
const hamburger = document.querySelector('.hamburger');
const navMenu = document.querySelector('.nav-menu');

function updateNavbar() {
    const token = localStorage.getItem('token');
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    const navMenuItems = navMenu.querySelectorAll('li');
    navMenuItems.forEach(item => {
        const link = item.querySelector('a');
        if (!link) return;
        const href = link.getAttribute('href');
        if (token) {
            if (href === 'login.html' || href === 'signup.html') item.style.display = 'none';
            else if (href === '#logout') item.style.display = 'block';
            else item.style.display = 'block';
        } else {
            if (href === 'login.html' || href === 'signup.html') item.style.display = 'block';
            else if (href === '#logout') item.style.display = 'none';
            else item.style.display = 'block';
        }
    });

    // Add admin link if user is admin
    if (token && user.role === 'admin') {
        if (!document.querySelector('a[href="admin.html"]')) {
            const adminLi = document.createElement('li');
            const adminLink = document.createElement('a');
            adminLink.href = 'admin.html';
            adminLink.textContent = 'Admin';
            // Insert before logout
            const logoutLi = document.querySelector('a[href="#logout"]').parentElement;
            navMenu.insertBefore(adminLi, logoutLi);
        }
    }
}
updateNavbar();

const logoutLink = document.querySelector('a[href="#logout"]');
if (logoutLink) logoutLink.addEventListener('click', () => {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    window.location.href = 'login.html';
});

hamburger.addEventListener('click', () => {
    navMenu.classList.toggle('active');
    hamburger.classList.toggle('active');
});

function addContactPage() {
    window.location.href = "add-contact.html";
}

/* Image upload and preview functionality */
const imageDropArea = document.getElementById('imageDropArea');
const imageInput = document.getElementById('editProfileImage');
const imagePreview = document.getElementById('imagePreview');

// Click to select image
imageDropArea.addEventListener('click', () => {
    imageInput.click();
});

// File input change
imageInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        previewImage(file);
    }
});

// Drag and drop events
imageDropArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    imageDropArea.classList.add('dragover');
});

imageDropArea.addEventListener('dragleave', () => {
    imageDropArea.classList.remove('dragover');
});

imageDropArea.addEventListener('drop', (e) => {
    e.preventDefault();
    imageDropArea.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
        imageInput.files = e.dataTransfer.files;
        previewImage(file);
    } else {
        alert('Please drop a valid image file.');
    }
});

// Preview image function
function previewImage(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
        imagePreview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
    };
    reader.readAsDataURL(file);
}
</script>
</body>

</html>