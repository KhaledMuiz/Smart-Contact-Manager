<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Smart Contact Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 px-0 sidebar">
                <div class="d-flex flex-column p-3">
                    <h5 class="mb-4 text-center">
                        <i class="fas fa-crown me-2"></i>Admin Panel
                    </h5>
                    <nav class="nav nav-pills flex-column">
                        <a class="nav-link active" href="#dashboard" onclick="showSection('dashboard')">
                            <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                        </a>
                        <a class="nav-link" href="#users" onclick="showSection('users')">
                            <i class="fas fa-users me-2"></i>Users
                        </a>
                        <a class="nav-link" href="#contacts" onclick="showSection('contacts')">
                            <i class="fas fa-address-book me-2"></i>Contacts
                        </a>
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-arrow-left me-2"></i>Back to App
                        </a>
                    </nav>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 px-0 main-content">
                <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm px-4">
                    <span class="navbar-brand mb-0 h1">Admin Dashboard</span>
                    <div class="ms-auto">
                        <button class="btn btn-outline-danger btn-sm" onclick="logout()">
                            <i class="fas fa-sign-out-alt me-1"></i>Logout
                        </button>
                    </div>
                </nav>

                <div class="container-fluid p-4">
                    <!-- Dashboard Section -->
                    <div id="dashboard-section" class="section">
                        <div class="row mb-4">
                            <div class="col-md-3 mb-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <div class="stat-icon mb-2"><i class="fas fa-users"></i></div>
                                        <h3 id="totalUsers">0</h3>
                                        <p class="text-muted mb-0">Total Users</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <div class="stat-icon mb-2"><i class="fas fa-address-book"></i></div>
                                        <h3 id="totalContacts">0</h3>
                                        <p class="text-muted mb-0">Total Contacts</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <div class="stat-icon mb-2"><i class="fas fa-user-shield"></i></div>
                                        <h3 id="adminUsers">0</h3>
                                        <p class="text-muted mb-0">Admin Users</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <div class="stat-icon mb-2"><i class="fas fa-user"></i></div>
                                        <h3 id="regularUsers">0</h3>
                                        <p class="text-muted mb-0">Regular Users</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="fas fa-chart-pie me-2"></i>User Roles Distribution</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="userRolesChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="fas fa-chart-bar me-2"></i>Recent Activity</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="recentActivity" class="list-group list-group-flush">
                                            <!-- Activity items will be loaded here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Users Section -->
                    <div id="users-section" class="section d-none">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2><i class="fas fa-users me-2"></i>Manage Users</h2>
                            <button class="btn btn-primary" onclick="refreshUsers()">
                                <i class="fas fa-sync me-1"></i>Refresh
                            </button>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>ID</th>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Role</th>
                                                <th>Created</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="usersTableBody">
                                            <!-- Users will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contacts Section -->
                    <div id="contacts-section" class="section d-none">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2><i class="fas fa-address-book me-2"></i>Manage Contacts</h2>
                            <button class="btn btn-primary" onclick="refreshContacts()">
                                <i class="fas fa-sync me-1"></i>Refresh
                            </button>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>ID</th>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Phone</th>
                                                <th>Category</th>
                                                <th>User</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="contactsTableBody">
                                            <!-- Contacts will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="deleteMessage">Are you sure you want to delete this item?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        // Check if user is admin
        if (!token || user.role !== 'admin') {
            window.location.href = 'login.html';
        }

        let currentSection = 'dashboard';
        let userRolesChart = null;

        // Show section
        function showSection(section) {
            document.querySelectorAll('.section').forEach(el => el.classList.add('d-none'));
            document.getElementById(section + '-section').classList.remove('d-none');
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.querySelector(`[href="#${section}"]`).classList.add('active');
            currentSection = section;

            if (section === 'dashboard') loadDashboard();
            else if (section === 'users') loadUsers();
            else if (section === 'contacts') loadContacts();
        }

        // Load dashboard data
        async function loadDashboard() {
            try {
                const [usersRes, contactsRes] = await Promise.all([
                    fetch('http://localhost:3000/api/admin/users', { headers: { Authorization: `Bearer ${token}` } }),
                    fetch('http://localhost:3000/api/admin/contacts', { headers: { Authorization: `Bearer ${token}` } })
                ]);

                const users = await usersRes.json();
                const contacts = await contactsRes.json();

                const totalUsers = users.length;
                const adminUsers = users.filter(u => u.role === 'admin').length;
                const regularUsers = totalUsers - adminUsers;

                document.getElementById('totalUsers').textContent = totalUsers;
                document.getElementById('totalContacts').textContent = contacts.length;
                document.getElementById('adminUsers').textContent = adminUsers;
                document.getElementById('regularUsers').textContent = regularUsers;

                // Update chart
                const ctx = document.getElementById('userRolesChart').getContext('2d');
                if (userRolesChart) userRolesChart.destroy();
                userRolesChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Admin', 'Regular Users'],
                        datasets: [{
                            data: [adminUsers, regularUsers],
                            backgroundColor: ['#667eea', '#764ba2']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });

                // Recent activity
                const activityList = document.getElementById('recentActivity');
                activityList.innerHTML = '';
                const recentUsers = users.slice(0, 5);
                recentUsers.forEach(u => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item';
                    item.innerHTML = `<i class="fas fa-user-plus me-2"></i>User "${u.name}" registered (${new Date(u.created_at).toLocaleDateString()})`;
                    activityList.appendChild(item);
                });

            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Load users
        async function loadUsers() {
            try {
                const response = await fetch('http://localhost:3000/api/admin/users', {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const users = await response.json();
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = '';

                users.forEach(u => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${u.id}</td>
                        <td>${u.name}</td>
                        <td>${u.email}</td>
                        <td><span class="badge bg-${u.role === 'admin' ? 'primary' : 'secondary'}">${u.role}</span></td>
                        <td>${new Date(u.created_at).toLocaleDateString()}</td>
                        <td>
                            ${u.id !== user.id ? `<button class="btn btn-danger btn-sm" onclick="deleteUser(${u.id}, '${u.name}')">
                                <i class="fas fa-trash"></i>
                            </button>` : '<span class="text-muted">Current User</span>'}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Load contacts
        async function loadContacts() {
            try {
                const response = await fetch('http://localhost:3000/api/admin/contacts', {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const contacts = await response.json();
                const tbody = document.getElementById('contactsTableBody');
                tbody.innerHTML = '';

                contacts.forEach(c => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${c.id}</td>
                        <td>${c.name}</td>
                        <td>${c.email || '-'}</td>
                        <td>${c.phone || '-'}</td>
                        <td><span class="badge bg-info">${c.category}</span></td>
                        <td>User ${c.user_id}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteContact(${c.id}, '${c.name}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading contacts:', error);
            }
        }

        // Delete user
        async function deleteUser(id, name) {
            if (confirm(`Are you sure you want to delete user "${name}"?`)) {
                try {
                    const response = await fetch(`http://localhost:3000/api/admin/users/${id}`, {
                        method: 'DELETE',
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    if (response.ok) {
                        loadUsers();
                        loadDashboard();
                    } else {
                        alert('Error deleting user');
                    }
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('Error deleting user');
                }
            }
        }

        // Delete contact
        async function deleteContact(id, name) {
            if (confirm(`Are you sure you want to delete contact "${name}"?`)) {
                try {
                    const response = await fetch(`http://localhost:3000/api/admin/contacts/${id}`, {
                        method: 'DELETE',
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    if (response.ok) {
                        loadContacts();
                        loadDashboard();
                    } else {
                        alert('Error deleting contact');
                    }
                } catch (error) {
                    console.error('Error deleting contact:', error);
                    alert('Error deleting contact');
                }
            }
        }

        // Refresh functions
        function refreshUsers() { loadUsers(); }
        function refreshContacts() { loadContacts(); }

        // Logout
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        // Initialize
        showSection('dashboard');
    </script>
</body>
</html>
