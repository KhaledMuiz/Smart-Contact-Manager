<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Details | Modern Address Book</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --accent: #7209b7;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4cc9f0;
            --danger: #ef233c;
            --warning: #fca311;
            --gray: #adb5bd;
            --transition: all 0.3s ease;
        }

        body {
            background-color: #f0f2f5;
            color: var(--dark);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .container {
            max-width: 1000px;
            width: 100%;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            animation: fadeIn 0.5s ease-out;
        }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }
        .header .back-btn:hover {
            background: rgba(158, 49, 209, 0.4);
            transform: translateY(-2px);
        }


        .header h1 {
            font-weight: 600;
            font-size: 24px;
        }

        .contact-content {
            display: flex;
            flex-wrap: wrap;
            padding: 30px;
        }

        .contact-profile {
            flex: 1;
            min-width: 300px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            animation: slideInLeft 0.5s ease-out;
        }

        .avatar {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid var(--light);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            transition: var(--transition);
        }

        .avatar:hover {
            transform: scale(1.05);
        }

        .contact-name {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--dark);
        }

        .contact-type {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 20px;
        }

        .type-work {
            background-color: #e0f4ff;
            color: #0066cc;
        }

        .type-personal {
            background-color: #ffe6e6;
            color: #cc0000;
        }

        .favorite-badge {
            background-color: var(--warning);
            color: white;
            padding: 5px 12px;
            border-radius: 50px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 25px;
        }

        .contact-details {
            flex: 2;
            min-width: 300px;
            padding: 20px;
            animation: slideInRight 0.5s ease-out;
        }

        .detail-card {
            background: var(--light);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
            transition: var(--transition);
        }

        .detail-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.05);
        }

        .detail-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: var(--primary);
            font-weight: 600;
        }

        .detail-header i {
            font-size: 20px;
        }

        .contact-info {
            font-size: 16px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .contact-info a {
            color: var(--dark);
            text-decoration: none;
            transition: var(--transition);
        }

        .contact-info a:hover {
            color: var(--primary);
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary);
            transform: translateY(-2px);
        }

        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #d90429;
            transform: translateY(-2px);
        }

        .additional-info {
            margin-top: 30px;
            padding: 20px;
            background: var(--light);
            border-radius: 12px;
            animation: fadeIn 0.8s ease-out;
        }

        .additional-info h3 {
            margin-bottom: 15px;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tags {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tag {
            padding: 5px 12px;
            background: white;
            border-radius: 50px;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        /* Side Panel (Drawer) */
.side-panel {
    position: fixed;
    top: 0;
    right: -100%;
    width: 400px;
    max-width: 90%;
    height: 100%;
    background: #fff;
    box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
    transition: right 0.4s ease;
    z-index: 9999;
    display: flex;
    flex-direction: column;
}

.side-panel.active {
    right: 0;
}

.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    background: var(--primary);
    color: #fff;
}

.close-btn {
    background: none;
    border: none;
    font-size: 28px;
    color: #fff;
    cursor: pointer;
}

.panel-content {
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.panel-content input,
.panel-content textarea {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 14px;
}


        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .contact-content {
                flex-direction: column;
            }

            .header {
                padding: 20px;
            }

            .contact-profile,
            .contact-details {
                padding: 15px;
            }

            .avatar {
                width: 150px;
                height: 150px;
            }
        }

        /* Modern Form Elements */
        .modern-input-group {
            margin-bottom: 20px;
        }

        .modern-input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
            font-size: 14px;
        }

        .modern-input-group input,
        .modern-input-group select,
        .modern-input-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .modern-input-group input:focus,
        .modern-input-group select:focus,
        .modern-input-group textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        .modern-input-group select {
            cursor: pointer;
        }

        /* Segmented Control for Category */
        .segmented-control {
            display: flex;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .segmented-control input[type="radio"] {
            display: none;
        }

        .segmented-control label {
            flex: 1;
            padding: 12px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 14px;
            color: #64748b;
            background: transparent;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .segmented-control label i {
            font-size: 16px;
        }

        .segmented-control input[type="radio"]:checked + label {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .segmented-control label:hover {
            background: #e2e8f0;
        }

        /* Image Preview for Profile */
        .image-preview-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .image-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid #e2e8f0;
            object-fit: cover;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .image-preview:hover {
            transform: scale(1.05);
        }

        .image-upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8fafc;
            position: relative;
        }

        .image-upload-area:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .image-upload-area.dragover {
            border-color: #10b981;
            background: #ecfdf5;
        }

        .upload-icon {
            font-size: 32px;
            color: #cbd5e1;
            margin-bottom: 8px;
        }

        .image-upload-area p {
            margin: 0;
            color: #64748b;
            font-size: 14px;
        }

        .image-upload-area input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        /* Expandable Textarea with Character Counter */
        .textarea-container {
            position: relative;
        }

        .expandable-textarea {
            width: 100%;
            min-height: 80px;
            padding: 12px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .expandable-textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        .character-counter {
            position: absolute;
            bottom: 8px;
            right: 12px;
            font-size: 12px;
            color: #94a3b8;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 6px;
            border-radius: 4px;
            pointer-events: none;
        }

        /* Panel content inputs */
        .panel-content input,
        .panel-content textarea {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="container">
        <header class="header">
            <button class="back-btn" onclick="goBack()">
                <i class="fas fa-arrow-left"></i> Back to Contacts
            </button>
            <div class="logo">
                <i class="fa-solid fa-address-book"></i>
                <span>Smart Contact Manager</span>
            </div>
        </header>

        <div class="contact-content">
            <div class="contact-profile">
                    <img src="" alt="Contact avatar" class="avatar">
                    <h2 class="contact-name">Loading...</h2>
                    <span class="contact-type">Loading...</span>
                    <span class="favorite-badge" style="display: none;"><i class="fas fa-star"></i> Favorite</span>
                </div>

            <div class="contact-details">
                <div class="detail-card">
                    <div class="detail-header">
                        <i class="fas fa-envelope"></i>
                        <h3>Email Address</h3>
                    </div>
                    <p class="contact-info">
                        <i class="fas fa-circle" style="font-size: 8px; color: var(--success);"></i>
                        <a href="mailto:"></a>
                    </p>
                </div>

                <div class="detail-card">
                    <div class="detail-header">
                        <i class="fas fa-phone"></i>
                        <h3>Phone Numbers</h3>
                    </div>
                    <p class="contact-info">
                        <i class="fas fa-mobile-alt" style="color: var(--primary);"></i>
                        <a href="tel:"></a>
                    </p>
                </div>

                <div class="detail-card">
                    <div class="detail-header">
                        <i class="fas fa-map-marker-alt"></i>
                        <h3>Address</h3>
                    </div>
                    <p class="contact-info">
                        <i class="fas fa-building" style="color: var(--accent);"></i>
                    </p>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="editContact()">
                        <i class="fas fa-edit"></i> Edit Contact
                    </button>
                    <button class="btn btn-outline" onclick="shareContact()">
                        <i class="fas fa-share-alt"></i> Share Contact
                    </button>
                    <button class="btn btn-danger" onclick="deleteContact()">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>

                <div class="additional-info">
                    <h3><i class="fas fa-sticky-note"></i> Notes</h3>
                    <p>No additional information available.</p>
                </div>


        <!-- Slide-in Edit Panel -->
        <div id="editPanel" class="side-panel">
            <div class="panel-header">
                <h2>Edit Contact</h2>
                <button class="close-btn" onclick="closeEditPanel()">&times;</button>
            </div>
            <div class="panel-content">
                <form id="editForm" enctype="multipart/form-data">
                    <div class="modern-input-group">
                        <label for="editName">Full Name</label>
                        <input type="text" id="editName" name="name" required>
                    </div>
                    <div class="modern-input-group">
                        <label for="editEmail">Email</label>
                        <input type="email" id="editEmail" name="email" required>
                    </div>
                    <div class="modern-input-group">
                        <label for="editPhone">Phone</label>
                        <input type="tel" id="editPhone" name="phone" required>
                    </div>
                    <div class="modern-input-group">
                        <label for="editAddress">Address</label>
                        <input type="text" id="editAddress" name="address">
                    </div>
                    <div class="modern-input-group">
                        <label>Category</label>
                        <div class="segmented-control">
                            <input type="radio" name="category" value="work" id="editCategoryWork">
                            <label for="editCategoryWork"><i class="fas fa-briefcase"></i> Work</label>
                            <input type="radio" name="category" value="personal" id="editCategoryPersonal">
                            <label for="editCategoryPersonal"><i class="fas fa-user"></i> Personal</label>
                        </div>
                    </div>
                    <div class="modern-input-group">
                        <label for="editNotes">Notes</label>
                        <div class="textarea-container">
                            <textarea id="editNotes" name="notes" class="expandable-textarea" rows="3"></textarea>
                            <div class="character-counter">0 / 500</div>
                        </div>
                    </div>
                    <div class="modern-input-group">
                        <label><input type="checkbox" id="editFavorite" name="is_favorite"> Favorite</label>
                    </div>
                    <div class="modern-input-group">
                        <label for="editProfileImage">Profile Image</label>
                        <div class="image-upload-area" id="imageDropArea">
                            <i class="fas fa-cloud-upload-alt upload-icon"></i>
                            <p>Drag & Drop image here or click to select</p>
                            <input type="file" id="editProfileImage" name="profile_image" accept="image/*">
                            <div class="image-preview-container">
                                <img class="image-preview" id="imagePreview" alt="Preview">
                            </div>
                        </div>
                    </div>
                    <div class="panel-actions">
                        <button type="button" class="btn btn-danger" onclick="closeEditPanel()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <script>
        
        const API_BASE = 'http://localhost:3000/api';
        const token = localStorage.getItem('token');
        if (!token) window.location.href = 'login.html';

        /* simpler URL param helper that supports `id` or `_id` */
        function getUrlParameter(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }
        function getContactId() {
            // support both id and _id in query string
            return getUrlParameter('id') || getUrlParameter('_id');
        }

        let currentContact = null;

        async function loadContactDetails() {
            const contactId = getContactId();
            if (!contactId) {
                // don't redirect immediately — show a friendly message
                document.querySelector('.contact-name').textContent = 'No contact ID provided';
                console.warn('No contact id in URL');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/contacts/${encodeURIComponent(contactId)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    currentContact = await response.json();
                    console.log('Loaded contact:', currentContact);

                    // src & profile
                    if (currentContact.profile_image) {
                        if (currentContact.profile_image.startsWith('profile_image-')) {
                            document.querySelector('.avatar').src = `/uploads/${currentContact.profile_image}`;
                        } else {
                            document.querySelector('.avatar').src = `./src/images/${currentContact.profile_image}`;
                        }
                    } else {
                        document.querySelector('.avatar').src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjUwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0zMCA0NUMzMCAzOC41IDI2LjUgMzMgMzAgMzNDMzMgMjYuNSAzOC41IDIxIDQ1IDIxQzUxLjUgMjEgNTcgMjYuNSA1NyAzM0M1NyAzOC41IDUxLjUgNDUgNDUgNDVDNTEuNSA1MS41IDU3IDU3IDU3IDYzVjY5QzU3IDc1LjUgNTEuNSA4MSA0NSA4MUMzOC41IDgxIDMzIDc1LjUgMzMgNjlWMzNaIiBmaWxsPSIjOUI5QkE0Ii8+Cjwvc3ZnPgo=';
                    }
                    document.querySelector('.avatar').alt = `Headshot of ${currentContact.name || ''}`;
                    document.querySelector('.contact-name').textContent = currentContact.name || '';
                    const cat = currentContact.category || 'personal';
                    const typeEl = document.querySelector('.contact-type');
                    typeEl.className = `contact-type type-${cat}`;
                    typeEl.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);

                    // favorite
                    const favBadge = document.querySelector('.favorite-badge');
                    if (favBadge) {
                        if (currentContact.is_favorite) favBadge.style.display = 'inline-flex';
                        else favBadge.style.display = 'none';
                    }

                    // email
                    const emailLink = document.querySelector('.detail-card:nth-of-type(1) .contact-info a');
                    if (emailLink) {
                        if (currentContact.email) {
                            emailLink.href = `mailto:${currentContact.email}`;
                            emailLink.textContent = currentContact.email;
                            emailLink.style.display = 'inline';
                        } else {
                            emailLink.style.display = 'none';
                        }
                    }

                    // phone
                    const phoneLink = document.querySelector('.detail-card:nth-of-type(2) .contact-info a');
                    if (phoneLink) {
                        if (currentContact.phone) {
                            phoneLink.href = `tel:${currentContact.phone.replace(/\s/g, '')}`;
                            phoneLink.textContent = currentContact.phone;
                            phoneLink.style.display = 'inline';
                        } else {
                            phoneLink.style.display = 'none';
                        }
                    }

                    // address
                    const addressInfo = document.querySelector('.detail-card:nth-of-type(3) .contact-info');
                    if (addressInfo) {
                        if (currentContact.address) {
                            addressInfo.innerHTML = `<i class="fas fa-building" style="color: var(--accent);"></i> ${currentContact.address}`;
                            addressInfo.style.display = 'flex';
                        } else {
                            addressInfo.style.display = 'none';
                        }
                    }

                    // notes
                    const additionalInfo = document.querySelector('.additional-info p');
                    if (additionalInfo) {
                        additionalInfo.textContent = currentContact.notes || '';
                    }

                    const tagsEl = document.querySelector('.tags');
                    if (tagsEl) {
                        tagsEl.style.display = 'none';
                    }

                } else if (response.status === 401) {
                    alert('Your session has expired. Please log in again.');
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = 'login.html';
                } else {
                    console.warn('Contact fetch failed, status:', response.status);
                    document.querySelector('.contact-name').textContent = 'Contact not found';
                    const additionalInfo = document.querySelector('.additional-info p');
                    if (additionalInfo) {
                        additionalInfo.textContent = '';
                    }
                }
            } catch (error) {
                console.error('Error loading contact details:', error);
                document.querySelector('.contact-name').textContent = 'Error loading contact';
                document.querySelector('.additional-info p').textContent = 'Unable to load contact details. Check your connection.';
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            loadContactDetails();
            const detailCards = document.querySelectorAll('.detail-card');
            detailCards.forEach((card, index) => {
                card.style.animationDelay = `${index * 0.1}s`;
            });
        });

        /* Edit panel interactions rely on currentContact — be tolerant about id/_id */
        function editContact() {
            if (!currentContact) return;
            document.getElementById('editName').value = currentContact.name || '';
            document.getElementById('editEmail').value = currentContact.email || '';
            document.getElementById('editPhone').value = currentContact.phone || '';
            document.getElementById('editAddress').value = currentContact.address || '';
            document.getElementById('editNotes').value = currentContact.notes || '';

            // Character counter for notes
            const notesTextarea = document.getElementById('editNotes');
            const characterCounter = document.querySelector('.character-counter');
            // Remove previous event listener if any to avoid multiple bindings
            notesTextarea.removeEventListener('input', updateCounter);
            function updateCounter() {
                const length = this.value.length;
                characterCounter.textContent = `${length} / 500`;
                if (length > 500) {
                    characterCounter.style.color = 'red';
                } else {
                    characterCounter.style.color = '#94a3b8';
                }
            }
            notesTextarea.addEventListener('input', updateCounter);
            // Initial update
            const initialLength = notesTextarea.value.length;
            characterCounter.textContent = `${initialLength} / 500`;

            // Set category
            const category = currentContact.category || 'personal';
            if (category === 'personal') {
                document.getElementById('editCategoryPersonal').checked = true;
            } else {
                document.getElementById('editCategoryWork').checked = true;
            }

            // Set favorite
            document.getElementById('editFavorite').checked = currentContact.is_favorite ? true : false;

            // Simple image preview and drag-drop using existing HTML elements
            const profileImageInput = document.getElementById('editProfileImage');
            const imagePreview = document.getElementById('imagePreview');
            const imageDropArea = document.getElementById('imageDropArea');

            // Set initial preview if existing image
            if (currentContact.profile_image) {
                if (currentContact.profile_image.startsWith('profile_image-')) {
                    imagePreview.src = `/uploads/${currentContact.profile_image}`;
                } else {
                    imagePreview.src = `./src/images/${currentContact.profile_image}`;
                }
                imagePreview.style.display = 'block';
            } else {
                imagePreview.style.display = 'none';
            }

            // Handle file selection
            profileImageInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    displayImagePreview(file);
                } else {
                    imagePreview.style.display = 'none';
                }
            });

            // Drag and drop functionality
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                imageDropArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                imageDropArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                imageDropArea.addEventListener(eventName, unhighlight, false);
            });

            function highlight(e) {
                imageDropArea.classList.add('dragover');
            }

            function unhighlight(e) {
                imageDropArea.classList.remove('dragover');
            }

            imageDropArea.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type.startsWith('image/')) {
                        // Create a new DataTransfer to set files
                        const dtNew = new DataTransfer();
                        dtNew.items.add(file);
                        profileImageInput.files = dtNew.files;
                        displayImagePreview(file);
                    }
                }
            }

            function displayImagePreview(file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }

            document.getElementById('editPanel').classList.add('active');
        }
        function closeEditPanel() {
            document.getElementById('editPanel').classList.remove('active');
        }

        /* Submit edit */
        document.getElementById('editForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            if (!currentContact) return;
            const idForApi = currentContact.id || currentContact._id;
            const formData = new FormData();
            formData.append('name', document.getElementById('editName').value);
            formData.append('email', document.getElementById('editEmail').value);
            formData.append('phone', document.getElementById('editPhone').value);
            formData.append('address', document.getElementById('editAddress').value);
            formData.append('category', document.querySelector('input[name="category"]:checked').value);
            formData.append('notes', document.getElementById('editNotes').value);
            const isFavorite = document.getElementById('editFavorite').checked ? 1 : 0;
            formData.append('is_favorite', isFavorite);
            const fileInput = document.getElementById('editProfileImage');
            if (fileInput.files[0]) {
                formData.append('profile_image', fileInput.files[0]);
            }
            try {
                const res = await fetch(`${API_BASE}/contacts/${encodeURIComponent(idForApi)}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                if (res.ok) {
                    currentContact = await res.json();
                    loadContactDetails(); // refresh DOM
                    alert('Contact updated successfully!');
                    closeEditPanel();
                } else if (res.status === 401) {
                    alert('Session expired. Please log in again.');
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = 'login.html';
                } else {
                    alert('Failed to update contact (status ' + res.status + ')');
                }
            } catch (err) {
                console.error('Error updating contact:', err);
                alert('Error updating contact');
            }
        });

        /* Delete from detail page */
        async function deleteContact() {
            if (!currentContact) { alert('Contact not loaded'); return; }
            if (!confirm(`Are you sure you want to delete "${currentContact.name}"?`)) return;
            try {
                const idForApi = currentContact.id || currentContact._id;
                const res = await fetch(`${API_BASE}/contacts/${encodeURIComponent(idForApi)}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    alert('Contact deleted');
                    window.location.href = 'contacts.html';
                } else {
                    alert('Failed to delete contact (status ' + res.status + ')');
                }
            } catch (err) {
                console.error('Error deleting contact:', err);
                alert('Error deleting contact');
            }
        }

        /* shareContact function (unchanged from your version) */
        function shareContact() {
            if (!currentContact) return;
            const shareData = {
                title: "Contact Info",
                text: `${currentContact.name}\nEmail: ${currentContact.email || 'N/A'}\nPhone: ${currentContact.phone || 'N/A'}`,
                url: window.location.href
            };
            if (navigator.share) {
                navigator.share(shareData).catch(() => alert("Sharing canceled or not supported."));
            } else {
                navigator.clipboard.writeText(shareData.text).then(() => alert("Contact info copied to clipboard!"));
            }
        }
    </script>

    <script>
        function goBack() {
            window.location.href = 'contacts.html';
        }

        const hamburger = document.querySelector('.hamburger');
        const navMenu = document.querySelector('.nav-menu');

        if (hamburger) {
            hamburger.addEventListener('click', () => {
                navMenu.classList.toggle('active');
                hamburger.classList.toggle('active');
            });
        }
        // Logout link
        const logoutLink = document.querySelector('a[href="#logout"]');
        if (logoutLink) {
            logoutLink.addEventListener('click', () => {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = 'login.html';
            });
        }
    </script>
</body>

</html>

